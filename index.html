<html>
  <head>
    <meta charset='UTF-8'>
    <title>Hello World!</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.js"></script>
    <!-- flot.js main plotting library and plugins -->
    <script language="javascript" type="text/javascript" src="node_modules/flot/jquery.flot.js"></script>
    <script language="javascript" type="text/javascript" src="node_modules/flot/jquery.flot.time.js"></script>
    <script language="javascript" type="text/javascript" src="node_modules/flot/jquery.flot.navigate.js"></script>
    <script language="javascript" type="text/javascript" src="node_modules/flot/jquery.flot.selection.js"></script>
    <script language="javascript" type="text/javascript" src="node_modules/flot/jquery.flot.fillbetween.js"></script>
    <script language="javascript" type="text/javascript" src="node_modules/flot/jquery.flot.crosshair.js"></script>
    <script language="javascript" type="text/javascript" src="node_modules/flot/jquery.flot.symbol.js"></script>
    <script language="javascript" type="text/javascript" src="static/scripts/jquery.flot.JUMlib.js"></script>
    <script language="javascript" type="text/javascript" src="static/scripts/jquery.flot.mouse.js"></script>



  </head>
  <body class=' full bleed'>
    <h1>Hello ConRad!</h1>
    We are using node <script>document.write(process.versions.node)</script>,
    Chrome <script>document.write(process.versions.chrome)</script>,
    and Electron <script>document.write(process.versions.electron)</script>.


    <div id='placeholder' style='height: 80%; width: 80%'></div>
    <div id='constraint-info' style='visible: false; width:'></div>
    <script>require('./test.js')</script>

    <script type="text/javascript">



    var dvhPlot = {}
    dvhPlot.upperConstraintIDs = {}
    dvhPlot.lowerConstraintIDs = {}
    dvhPlot.upperConstraints = []
    dvhPlot.lowerConstraints = []
    dvhPlot.dvhCurve = [[0, 100],[40, 80],[50, 50],[60, 20],[70, 8],[75, 0]]
    var kSeriesIdxUpper = 0
    var kSeriesIdxLower = 1
    var kSeriesIdxDVH = 2
    dvhPlot.plotData = []
    dvhPlot.plotOptions = []
    dvhPlot.canvas = $('#placeholder')
    dvhPlot.draw = null
    dvhPlot.structureName = 'test structure'
    dvhPlot.structureColor = '#b00'

    function showConstraintInfo(percentile, dose, direction){
      var infoBox = $('#constraint-info')
      infoBox.contents = 'D'.concat(percentile).concat(' ').concat(direction).concat(' = ').concat(dose).concat('Gy\n')
    }

    function hideConstraintInfo(){
      $('#constraint-info').fadeOut
    }
    showConstraintInfo(1, 2, 3)

    function addConstraint(percentile, dose, direction){
      var fraction = percentile / 100
      console.log("AJAX CALL TO MAKE NEW DOSE CONSTRAINT, GET ID, HERE")
    }

    function sendConstraint(constrID, percentile, dose, direction){
      var fraction = percentile / 100

      console.log("AJAX CALL TO SEND DOSE CONSTRAINT HERE")
    }

    function fetchConstraints(){
      return null
      console.log("AJAX CALL TO GET DOSE CONSTRAINTS HERE")
    }

    function fetchCurve(){
      return null
      console.log("AJAX CALL TO GET DVH CURVE HERE")
    }

    function leftPointingTriangle(ctx, x, y, radius, shadow) {
      // pi * r^2 = 1/2 * s^2 * sin (pi / 3)  =>  s = r * sqrt(2 * pi / sin(pi / 3))
      var size = radius * Math.sqrt(2 * Math.PI / Math.sin(Math.PI / 3));
      var height = size * Math.sin(Math.PI / 3);
      ctx.lineTo(x + size, y + height/2);
      if (!shadow) {
          ctx.lineTo(x + size, y - height/2);
          ctx.lineTo(x, y);
      }
    }

    function rightPointingTriangle(ctx, x, y, radius, shadow) {
      // pi * r^2 = 1/2 * s^2 * sin (pi / 3)  =>  s = r * sqrt(2 * pi / sin(pi / 3))
      var size = radius * Math.sqrt(2 * Math.PI / Math.sin(Math.PI / 3));
      var height = size * Math.sin(Math.PI / 3);
      ctx.lineTo(x - size, y + height/2);
      ctx.lineTo(x - size, y - height/2);
      if (!shadow) {
          ctx.lineTo(x, y);
      }
    }


    function nonnegOrthantBracket(ctx, x, y, radius, shadow) {
      // pi * r^2 = 1/2 * s^2 * sin (pi / 3)  =>  s = r * sqrt(2 * pi / sin(pi / 3))
      var size = radius * Math.sqrt(2 * Math.PI / Math.sin(Math.PI / 3));
      ctx.moveTo(x, y);
      ctx.lineTo(x, y - size);
      ctx.moveTo(x, y);
      ctx.lineTo(x + size, y);
    }

    function nonposOrthantBracket(ctx, x, y, radius, shadow) {
      // pi * r^2 = 1/2 * s^2 * sin (pi / 3)  =>  s = r * sqrt(2 * pi / sin(pi / 3))
      var size = radius * Math.sqrt(2 * Math.PI / Math.sin(Math.PI / 3));
      ctx.moveTo(x, y);
      ctx.lineTo(x - size, y);
      ctx.moveTo(x, y);
      ctx.lineTo(x, y + size);
    }

    var useTriangles = false
    var upperSymbol = nonnegOrthantBracket
    var lowerSymbol = nonposOrthantBracket
    if (useTriangles){
      upperSymbol = leftPointingTriangle
      lowerSymbol = rightPointingTriangle
    }




    function getConstraintID(seriesIndex, dataIndex){
      if (seriesIndex === kSeriesIdxLower){
        console.log('LOWER')
        return dvhPlot.lowerConstraintIDs[dataIndex]
      } else if (seriesIndex === kSeriesIdxUpper) {
        console.log('UPPER')
        return dvhPlot.upperConstraintIDs[dataIndex]
      } else
        // TODO: exception?
        alert('seriesIndex must correspond to upper or lower \
          constraint series to retrieve constraint ID')
    }


    var constraints = {cid1: [50, 0.8, '<'], cid2: [60, 0.4, '<'], cid3: [50, 0.2, '>']}

    function buildConstraintSeries(constraintSet){
      var iLower = 0; iUpper = 0
      for (constrID in constraintSet) {
        constr = constraintSet[constrID]
        if (constr[2] === '<'){
          dvhPlot.upperConstraints.push([constr[0], 100 * constr[1]])
          dvhPlot.upperConstraintIDs[iUpper] = constrID
          iUpper ++        
        } else {
          dvhPlot.lowerConstraints.push([constr[0], 100 * constr[1]])
          dvhPlot.lowerConstraintIDs[iLower] = constrID
          iLower ++
        }
      }
    }

    buildConstraintSeries(constraints)


    dvhPlot.plotOptions = {
      series: { 
        editMode: 'xy',
        lines: { show: false },
        points: { show: true }
      },
      grid: { 
        hoverable: true, 
        clickable: true, 
        editable: true 
      },
      yaxis: { min: 0, max: 103 },
      xaxis: { min: 0, max: 80 },
      legend: false               
    };

    dvhPlot.plotData = [ { data: dvhPlot.upperConstraints, label: 'upper constraints <STRUCTURE>', 
      editable: true, lines: {show: false}, points: {show: true, symbol: upperSymbol}, color: dvhPlot.structureColor},
      { data: dvhPlot.lowerConstraints, label: 'lower constraints <STRUCTURE>', 
      editable: true, lines: {show: false}, points: {show: true, symbol: lowerSymbol}, color: dvhPlot.structureColor},
      { data: dvhPlot.dvhCurve, label: 'DVH curve <STRUCTURE>', 
      editable: false, lines: {show: true}, points: {show: false}, color: dvhPlot.structureColor} ];

    var plot = $.plot(dvhPlot.canvas, dvhPlot.plotData, dvhPlot.plotOptions);

    function showTooltip(x, y, contents) {
        $('<div id="tooltip">' + contents + '</div>').css( {
            position: 'absolute',
            display: 'none',
            top: y + 5,
            left: x + 5,
            border: '1px solid #fdd',
            padding: '2px',
            'background-color': '#fee',
            opacity: 0.80
        }).appendTo("body").fadeIn(200);
    }

    var previousPoint = null;

    dvhPlot.canvas.bind("plothover", function (event, pos, item) {
        $("#x").text(pos.x.toFixed(2));
        $("#y").text(pos.y.toFixed(2));

        if ($("#enableTooltip:checked").length > 0) {
            if (item) {
                if (previousPoint != item.dataIndex) {
                    previousPoint = item.dataIndex;

                    $("#tooltip").remove();
                    var x = item.datapoint[0].toFixed(2),
                        y = item.datapoint[1].toFixed(2);

                    showTooltip(item.pageX, item.pageY,
                                item.series.label + " of " + x + " = " + y);
                }
            }
            else {
                $("#tooltip").remove();
                previousPoint = null;
            }
        }
    });

    dvhPlot.canvas.bind("plotclick", function (event, pos, item) {
        if (item) {
            $("#clickdata").html("<i> You clicked point " + item.dataIndex + " in " + item.series.label + ".</i>");
            plot.highlight(item.series, item.datapoint);
        }
    });
    $("#placeholder").bind("plotdown", function(event,pos,item){
      $("#log").append("\nplotdown(" + item.seriesIndex + "," + item.dataIndex + ")"); });
    $("#placeholder").bind("plotup", function(event,pos,item){
      $("#log").append( "\nplotup at " + pos.x1.toFixed(2) + "," + pos.y1.toFixed(2)); });
    $("#placeholder").bind("datadrop", function(event,pos,item) {
      var txt = "Datapoint(" + item.seriesIndex + "," + item.dataIndex + ") dragged";
      txt+= "\nfrom " + item.datapoint[0].toFixed(2) + " , " + item.datapoint[1].toFixed(2);
      txt+= "\nto " + pos.x1.toFixed(2) + " , " + pos.y1.toFixed(2);
      $("#dragdropdata").html("<b>" + txt + "</b>");
      $("#log").append( "\ndatadrop(" + item.seriesIndex + "," + item.dataIndex + ")"
               +" to " + pos.x1.toFixed(2) + "," + pos.y1.toFixed(2));
      if(true) {
        dvhPlot.plotData[item.seriesIndex].data[item.dataIndex] = [pos.x1,pos.y1];
        plot = $.plot(dvhPlot.canvas, dvhPlot.plotData, dvhPlot.plotOptions);
        console.log("GET CONSTRAINT ID")
        console.log(getConstraintID(item.seriesIndex, item.dataIndex))
        console.log("GET COORDINATES")
        console.log("x ", pos.x1, "y", pos.y1)
        console.log("UPDATE COSNTRAINT")
        console.log("SEND DVH CONSTRAINT!")
        console.log("RUN!")
        console.log("REDRAW DVH CURVE")
      }
    });


    </script>
  </body>
</html>